<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | Finder's Keeper</title>
    <link href="StyleSheet.css" rel="stylesheet" />
    <!-- AWS SDK -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>
    <!-- Amazon Cognito Identity SDK -->
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.6/dist/amazon-cognito-identity.min.js"></script>
    <style>
        .profile-container {
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
        }

        .profile-header {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #0ea5a4, #10b981);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin: 0 auto 20px;
        }

        .profile-name {
            font-size: 32px;
            margin-bottom: 10px;
            color: white;
        }

        .profile-email {
            color: #94a3b8;
            font-size: 16px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #0ea5a4;
        }

        .stat-label {
            color: #94a3b8;
            margin-top: 5px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 24px;
            color: white;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: 0;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            background: rgba(255, 255, 255, 0.05);
            color: #94a3b8;
        }

        .tab-btn.active {
            background: var(--accent);
            color: white;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-top: 20px;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body style="background: #0b1220; color: white; font-family: sans-serif;">

    <header class="topbar">
        <div class="brand">
            <span class="logo">üîç</span>
            <span class="title">Finder's Keeper</span>
        </div>
        <nav class="nav">
            <a href="messages.html" class="btn primary" id="messagesLink">
                üì¨ Messages <span id="unreadBadge" style="display:none; background:#ef4444; padding:2px 8px; border-radius:10px; font-size:12px; margin-left:5px;">0</span>
            </a>
            <a href="index.html" class="btn secondary">‚Üê Back to Feed</a>
            <button id="logoutBtn" class="btn secondary">Logout</button>
        </nav>
    </header>

    <main class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar" id="profileAvatar">üë§</div>
            <h1 class="profile-name" id="profileName">Loading...</h1>
            <p class="profile-email" id="profileEmail"></p>
            
            <div class="profile-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalItems">0</div>
                    <div class="stat-label">Total Posts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lostItems">0</div>
                    <div class="stat-label">Lost Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="foundItems">0</div>
                    <div class="stat-label">Found Items</div>
                </div>
            </div>
        </div>

        <div class="section-header">
            <h2 class="section-title">My Posts</h2>
            <div class="tab-buttons">
                <button class="tab-btn active" data-filter="all">All</button>
                <button class="tab-btn" data-filter="lost">Lost</button>
                <button class="tab-btn" data-filter="found">Found</button>
            </div>
        </div>

        <div class="items-grid" id="userItems">
            <div class="empty-state">
                <h3>üì¶ Loading your posts...</h3>
            </div>
        </div>
    </main>

    <script src="aws-config.js"></script>
    <script src="utils.js"></script>
    <script>
        let userItems = [];
        let activeFilter = 'all';

        async function loadUserProfile() {
            try {
                // Check authentication and redirect if not logged in
                if (!await utils.requireAuth()) {
                    return;
                }

                const user = awsService.getCurrentUser();

                // Update profile header
                document.getElementById('profileName').textContent = user.name;
                document.getElementById('profileEmail').textContent = user.email;
                
                // Set avatar initial
                document.getElementById('profileAvatar').textContent = utils.getUserInitial(user.name);

                // Load all items and filter user's items
                const allItems = await awsService.getItems();
                userItems = allItems.filter(item => item.userId === user.userId);

                // Load unread message count
                try {
                    const messagesData = await awsService.getMessages();
                    if (messagesData.unreadCount > 0) {
                        const badge = document.getElementById('unreadBadge');
                        badge.textContent = messagesData.unreadCount;
                        badge.style.display = 'inline-block';
                    }
                } catch (error) {
                    console.warn('Could not load message count:', error);
                }

                // Update statistics
                document.getElementById('totalItems').textContent = userItems.length;
                document.getElementById('lostItems').textContent = userItems.filter(item => item.status === 'lost').length;
                document.getElementById('foundItems').textContent = userItems.filter(item => item.status === 'found').length;

                // Render items
                renderUserItems();

            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Failed to load profile: ' + error.message);
            }
        }

        function renderUserItems() {
            const container = document.getElementById('userItems');
            
            // Filter items based on active filter
            let filteredItems = userItems;
            if (activeFilter !== 'all') {
                filteredItems = userItems.filter(item => item.status === activeFilter);
            }

            // Sort by date (newest first)
            filteredItems.sort((a, b) => {
                const dateA = new Date(a.createdAt || a.date);
                const dateB = new Date(b.createdAt || b.date);
                return dateB - dateA;
            });

            if (filteredItems.length === 0) {
                utils.showEmptyState(container, `No ${activeFilter === 'all' ? '' : activeFilter} items yet`, 'üòï');
                container.innerHTML += '<p style="grid-column: 1 / -1; text-align: center; color: #94a3b8;">Start posting items to see them here!</p><a href="postItem.html" class="btn primary" style="grid-column: 1 / -1; display: inline-block; margin: 20px auto; text-align: center; max-width: 200px;">+ Post New Item</a>';
            } else {
                container.innerHTML = '';
                filteredItems.forEach(item => {
                    const card = utils.createItemCard(item);
                    
                    // Add resolved badge if applicable
                    if (item.resolved) {
                        const preview = card.querySelector('.card-preview');
                        preview.style.opacity = '0.6';
                        preview.style.filter = 'grayscale(50%)';
                        preview.innerHTML = '<div style="position: absolute; top: 10px; right: 10px; background: #10b981; color: white; padding: 8px 12px; border-radius: 8px; font-weight: bold; font-size: 12px;">‚úì RESOLVED</div>';
                    }
                    
                    container.appendChild(card);
                });
            }
        }

        // Tab filtering
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                activeFilter = e.target.dataset.filter;
                renderUserItems();
            });
        });

        // Logout functionality
        utils.setupLogoutButton();

        // Load profile on page load
        loadUserProfile();
    </script>
</body>
</html>
